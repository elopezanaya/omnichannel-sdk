<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>getPersistentChatHistory - Browser Integration Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .alert.info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .alert.warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .test-controls {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .config-section {
            background: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .config-section h3 {
            margin-top: 0;
            color: #495057;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .status.loading {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .status.success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .status.error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        #console {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 5px;
            height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            margin-top: 20px;
        }
        .network-info {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .input-group {
            margin: 10px 0;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .input-group input, .input-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .input-group textarea {
            height: 80px;
            resize: vertical;
        }
        code {
            background-color: #f8f9fa;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
        .setup-section {
            background: #fff3cd;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid #ffeaa7;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç getPersistentChatHistory - Browser Integration Test</h1>
        
        <div class="alert info">
            <h3>üìã Purpose</h3>
            <p>This test helps developers verify that the <code>getPersistentChatHistory</code> API works correctly in a browser environment with real network calls. Use this for:</p>
            <ul>
                <li>Testing with real authentication tokens</li>
                <li>Debugging network issues</li>
                <li>Validating response formats</li>
                <li>Testing pagination behavior</li>
                <li>Verifying message count accuracy</li>
            </ul>
        </div>

        <div class="setup-section">
            <h3>üîß Setup Instructions</h3>
            <ol>
                <li>Make sure you've built the SDK: <code>npm run build:dev</code></li>
                <li>Update the configuration below with your actual values</li>
                <li>Ensure you have a valid authenticated user token</li>
                <li>Open Developer Tools (F12) ‚Üí Network tab for detailed monitoring</li>
            </ol>
        </div>

        <div class="network-info">
            <h3>üì° Network Monitoring</h3>
            <ol>
                <li>Open <strong>Developer Tools</strong> (F12)</li>
                <li>Go to the <strong>Network</strong> tab</li>
                <li>Filter by <code>livechatconnector</code> or <code>conversation/history</code></li>
                <li>Run the test below and inspect:</li>
                <ul>
                    <li>Request URL and method</li>
                    <li>Request headers (authentication, page size, etc.)</li>
                    <li>Response status and headers</li>
                    <li>Response body (chat messages)</li>
                    <li>Timing information</li>
                </ul>
            </ol>
        </div>

        <div class="config-section">
            <h3>üîß Configuration</h3>
            <div class="input-group">
                <label for="orgId">Organization ID:</label>
                <input type="text" id="orgId" value="YOUR_ORG_ID" placeholder="e.g., caf979e3-887e-f011-b4c0-000d3a340b7a">
            </div>
            <div class="input-group">
                <label for="orgUrl">Organization URL:</label>
                <input type="text" id="orgUrl" value="https://YOUR_ORG.crm.dynamics.com" placeholder="e.g., https://yourorg.crm.dynamics.com">
            </div>
            <div class="input-group">
                <label for="widgetId">Widget ID:</label>
                <input type="text" id="widgetId" value="YOUR_WIDGET_ID" placeholder="e.g., aa93b293-99e2-4f5e-a98b-159123b5a12a">
            </div>
            <div class="input-group">
                <label for="authToken">Authenticated User Token:</label>
                <textarea id="authToken" placeholder="Paste your JWT token here">YOUR_VALID_AUTH_TOKEN</textarea>
            </div>
            <div class="input-group">
                <label for="pageSize">Page Size:</label>
                <input type="number" id="pageSize" value="5" min="1" max="50">
            </div>
            <div class="input-group">
                <label for="requestId">Request ID (auto-generated if empty):</label>
                <input type="text" id="requestId" placeholder="Leave empty for auto-generation">
            </div>
        </div>

        <div class="test-controls">
            <h3>üß™ Test Controls</h3>
            <button id="runTestBtn" onclick="runTest()">Run Test</button>
            <button onclick="clearConsole()">Clear Console</button>
            <button onclick="copyConsoleOutput()">Copy Console Output</button>
            <button onclick="exportTestResults()">Export Results</button>
        </div>

        <div id="status"></div>

        <div>
            <h3>üìù Console Output</h3>
            <div id="console"></div>
        </div>
    </div>

    <!-- Load the compiled SDK (relative to project root) -->
    <script src="../../../dist/SDK.js"></script>

    <script>
        let lastTestResults = null;

        // Console output management
        function logToConsole(message, type = 'info') {
            const console_div = document.getElementById('console');
            const timestamp = new Date().toLocaleTimeString();
            
            let colorCode = '';
            switch(type) {
                case 'error': colorCode = '#ff6b6b'; break;
                case 'success': colorCode = '#51cf66'; break;
                case 'warning': colorCode = '#ffd43b'; break;
                case 'info': colorCode = '#74c0fc'; break;
                default: colorCode = '#d4d4d4'; break;
            }
            
            const logEntry = `[${timestamp}] ${message}\n`;
            console_div.innerHTML += `<span style="color: ${colorCode}">${logEntry}</span>`;
            console_div.scrollTop = console_div.scrollHeight;
            
            // Also log to browser console
            console.log(message);
        }

        function clearConsole() {
            document.getElementById('console').innerHTML = '';
        }

        function copyConsoleOutput() {
            const consoleContent = document.getElementById('console').textContent;
            navigator.clipboard.writeText(consoleContent).then(() => {
                showStatus('Console output copied to clipboard!', 'success');
            });
        }

        function exportTestResults() {
            if (!lastTestResults) {
                showStatus('No test results to export. Run a test first.', 'warning');
                return;
            }

            const exportData = {
                timestamp: new Date().toISOString(),
                testResults: lastTestResults,
                consoleOutput: document.getElementById('console').textContent
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `getPersistentChatHistory-test-results-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showStatus('Test results exported successfully!', 'success');
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            
            if (type !== 'loading') {
                setTimeout(() => {
                    statusDiv.className = '';
                    statusDiv.textContent = '';
                }, 5000);
            }
        }

        function validateConfiguration() {
            const orgId = document.getElementById('orgId').value.trim();
            const orgUrl = document.getElementById('orgUrl').value.trim();
            const widgetId = document.getElementById('widgetId').value.trim();
            const authToken = document.getElementById('authToken').value.trim();

            const errors = [];

            if (!orgId || orgId === 'YOUR_ORG_ID') {
                errors.push('Organization ID is required and must be updated from placeholder');
            }

            if (!orgUrl || orgUrl === 'https://YOUR_ORG.crm.dynamics.com') {
                errors.push('Organization URL is required and must be updated from placeholder');
            }

            if (!widgetId || widgetId === 'YOUR_WIDGET_ID') {
                errors.push('Widget ID is required and must be updated from placeholder');
            }

            if (!authToken || authToken === 'YOUR_VALID_AUTH_TOKEN') {
                errors.push('Authenticated User Token is required and must be updated from placeholder');
            }

            return errors;
        }

        async function runTest() {
            const runButton = document.getElementById('runTestBtn');
            runButton.disabled = true;
            lastTestResults = null;
            
            try {
                showStatus('üöÄ Starting test...', 'loading');
                clearConsole();
                
                logToConsole('Starting real call test for getPersistentChatHistory...', 'info');
                
                // Validate configuration
                const configErrors = validateConfiguration();
                if (configErrors.length > 0) {
                    configErrors.forEach(error => logToConsole(`‚ùå Configuration Error: ${error}`, 'error'));
                    showStatus('‚ùå Configuration errors found. Check console for details.', 'error');
                    return;
                }
                
                // Get values from inputs
                const omnichannelConfig = {
                    orgId: document.getElementById('orgId').value.trim(),
                    orgUrl: document.getElementById('orgUrl').value.trim(),
                    widgetId: document.getElementById('widgetId').value.trim(),
                    channelId: 'lcw'
                };

                const authToken = document.getElementById('authToken').value.trim();
                const pageSize = parseInt(document.getElementById('pageSize').value) || 5;
                const requestIdInput = document.getElementById('requestId').value.trim();
                const requestId = requestIdInput || 'test-request-' + Date.now();
                
                logToConsole(`üìã Configuration:`, 'info');
                logToConsole(`   Org ID: ${omnichannelConfig.orgId}`, 'info');
                logToConsole(`   Org URL: ${omnichannelConfig.orgUrl}`, 'info');
                logToConsole(`   Widget ID: ${omnichannelConfig.widgetId}`, 'info');
                logToConsole(`   Channel ID: ${omnichannelConfig.channelId}`, 'info');
                logToConsole(`   Request ID: ${requestId}`, 'info');
                logToConsole(`   Page Size: ${pageSize}`, 'info');
                logToConsole(`   Auth Token Length: ${authToken.length} chars`, 'info');
                
                // Check if SDK is available
                if (typeof window.Microsoft === 'undefined' || 
                    typeof window.Microsoft.CRM === 'undefined' || 
                    typeof window.Microsoft.CRM.Omnichannel === 'undefined' || 
                    typeof window.Microsoft.CRM.Omnichannel.SDK === 'undefined') {
                    throw new Error('SDK not loaded. Make sure dist/SDK.js is properly built and loaded.');
                }
                
                const sdk = window.Microsoft.CRM.Omnichannel.SDK.SDKProvider.getSDK(omnichannelConfig);
                
                const params = {
                    authenticatedUserToken: authToken,
                    pageSize: pageSize,
                    pageToken: undefined
                };

                logToConsole('Making API call with params:', 'info');
                logToConsole(`   Request ID: ${requestId}`, 'info');
                logToConsole(`   Page Size: ${params.pageSize}`, 'info');
                logToConsole(`   Has Auth Token: ${!!params.authenticatedUserToken}`, 'info');
                
                logToConsole('üåê Check the Network tab in DevTools to see the HTTP requests!', 'warning');

                const startTime = Date.now();
                const result = await sdk.getPersistentChatHistory(requestId, params);
                const endTime = Date.now();
                const duration = endTime - startTime;
                
                // Log message count validation
                const requestedPageSize = params.pageSize;
                const receivedMessages = result.messages || result.conversations || result.chatMessages || [];
                const actualCount = Array.isArray(receivedMessages) ? receivedMessages.length : 0;
                
                logToConsole(`üìä Message Count Analysis:`, 'info');
                logToConsole(`   Requested: ${requestedPageSize} messages`, 'info');
                logToConsole(`   Received: ${actualCount} messages`, 'info');
                const matchStatus = actualCount === requestedPageSize ? '‚úÖ YES' : `‚ùå NO (difference: ${actualCount - requestedPageSize})`;
                logToConsole(`   Match: ${matchStatus}`, actualCount === requestedPageSize ? 'success' : 'warning');
                logToConsole(`   Response Time: ${duration}ms`, 'info');
                
                logToConsole('‚úÖ Success! Result structure:', 'success');
                logToConsole(`   Keys: ${Object.keys(result).join(', ')}`, 'info');
                logToConsole('Full result:', 'info');
                logToConsole(JSON.stringify(result, null, 2), 'info');
                
                // Store results for export
                lastTestResults = {
                    config: omnichannelConfig,
                    requestId,
                    requestedPageSize,
                    actualCount,
                    match: actualCount === requestedPageSize,
                    duration,
                    result
                };
                
                // Test pagination if nextPageToken exists
                if (result.nextPageToken) {
                    logToConsole('üìÑ Testing pagination...', 'info');
                    const nextPageParams = {
                        ...params,
                        pageToken: result.nextPageToken
                    };
                    
                    const nextPageStartTime = Date.now();
                    const nextPageResult = await sdk.getPersistentChatHistory(requestId, nextPageParams);
                    const nextPageEndTime = Date.now();
                    const nextPageDuration = nextPageEndTime - nextPageStartTime;
                    
                    // Log next page message count validation
                    const nextPageMessages = nextPageResult.messages || nextPageResult.conversations || nextPageResult.chatMessages || [];
                    const nextPageActualCount = Array.isArray(nextPageMessages) ? nextPageMessages.length : 0;
                    
                    logToConsole(`üìä Next Page Message Count Analysis:`, 'info');
                    logToConsole(`   Requested: ${params.pageSize} messages`, 'info');
                    logToConsole(`   Received: ${nextPageActualCount} messages`, 'info');
                    const nextMatchStatus = nextPageActualCount === params.pageSize ? '‚úÖ YES' : `‚ùå NO (difference: ${nextPageActualCount - params.pageSize})`;
                    logToConsole(`   Match: ${nextMatchStatus}`, nextPageActualCount === params.pageSize ? 'success' : 'warning');
                    logToConsole(`   Response Time: ${nextPageDuration}ms`, 'info');
                    
                    logToConsole('‚úÖ Next page result:', 'success');
                    logToConsole(JSON.stringify(nextPageResult, null, 2), 'info');
                    
                    // Update results with pagination info
                    lastTestResults.pagination = {
                        nextPageActualCount,
                        nextPageMatch: nextPageActualCount === params.pageSize,
                        nextPageDuration,
                        nextPageResult
                    };
                }

                showStatus('‚úÖ Test completed successfully!', 'success');

            } catch (error) {
                logToConsole('‚ùå Error: ' + error.message, 'error');
                logToConsole('Full error:', 'error');
                logToConsole(JSON.stringify(error, null, 2), 'error');
                
                // Common error scenarios to check:
                if (error.message.includes('Authenticated user token is required')) {
                    logToConsole('üí° Tip: You need to provide a valid authenticatedUserToken', 'warning');
                }
                if (error.message.includes('timeout')) {
                    logToConsole('üí° Tip: The request timed out - check network connectivity', 'warning');
                }
                if (error.message.includes('404')) {
                    logToConsole('üí° Tip: Check your orgId, orgUrl, and widgetId configuration', 'warning');
                }
                if (error.message.includes('401') || error.message.includes('403')) {
                    logToConsole('üí° Tip: Check your authenticatedUserToken - it may be invalid or expired', 'warning');
                }
                if (error.message.includes('CORS')) {
                    logToConsole('üí° Tip: CORS error - make sure your domain is whitelisted or serve via localhost', 'warning');
                }
                
                showStatus('‚ùå Test failed. Check console for details.', 'error');
                
                // Store error results for export
                lastTestResults = {
                    error: {
                        message: error.message,
                        stack: error.stack,
                        fullError: error
                    }
                };
            } finally {
                runButton.disabled = false;
            }
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            logToConsole('üîß Page loaded. Ready to run tests!', 'info');
            logToConsole('üì° Open DevTools Network tab to monitor HTTP requests', 'warning');
            
            // Check if SDK is available
            if (typeof window.Microsoft === 'undefined' || 
                typeof window.Microsoft.CRM === 'undefined' || 
                typeof window.Microsoft.CRM.Omnichannel === 'undefined' || 
                typeof window.Microsoft.CRM.Omnichannel.SDK === 'undefined') {
                logToConsole('‚ö†Ô∏è WARNING: SDK not detected. Make sure to build the project first:', 'error');
                logToConsole('   npm run build:dev', 'error');
                showStatus('‚ö†Ô∏è SDK not loaded. Build the project first with npm run build:dev', 'error');
            } else {
                logToConsole('‚úÖ SDK loaded successfully', 'success');
            }
        });
    </script>
</body>
</html>